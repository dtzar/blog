# Setting up a Jenkins pipeline on top of Kubernetes

Prerequisites:

- An existing 1.9+ kubernetes cluster deployed with kubectl access.  This could be [ACS-Engine](https://github.com/Azure/acs-engine/blob/master/docs/kubernetes/deploy.md) or [AKS](https://docs.microsoft.com/en-us/azure/aks/tutorial-kubernetes-deploy-cluster).
- Helm 2.8+ installed on the client and matching version on the K8s cluster

This is the workflow to follow:

1. Install Jenkins on Kubernetes
1. Configure Jenkins to utilize your Jenkinsfile pipeline from a GitHub repo
1. Execute the pipeline

## Install Jenkins on Kubernetes

1. Ensure your local helm repo cache is up to date: `helm repo update`

1. (Optional) Create external DNS-based access to Jenkins

    By default the configuration steps in step 3 will expose the Jenkins service with a public IP address without a DNS name.  Jenkins can be successfully accessed and used simply by using the public IP of the service if this step is skipped. However, A DNS name configuration is required for the proper operation for some Jenkins features like email notifications and PR status updates.  This can be accomplished by assigning a DNS name to the public IP (Option A) OR if there is an existing ingress controller on the cluster with a DNS name, Jenkins can simply have an ingress rule added associated with the Jenkins service (Option B).

    ### Option A - Assign a public DNS name for the Jenkins service

    This will enable Jenkins to automatically have a DNS name generated by the native Kubernetes and Azure integration.  It generates a DNS name for the public IP address created via the Jenkins Kubernetes service.

    In order to accomplish this, modify the `./code/values.yaml` file from this repo as follows:

    - Uncomment line 51 and place the contents inside the brackets of line 50.  It should look something like this: `ServiceAnnotations: {service.beta.kubernetes.io/azure-dns-label-name: "jenkinsk8s4azureyo"}`
    - Change the `jenkinsk8s4azureyo` to be a globally unique value per datacenter region.  
        > Once provisioned the DNS name to access Jenkins will be like `jenkinsk8s4azureyo.westus.cloudapp.azure.com` where the `westus` value corresponds to the azure datacenter location where the kubernetes cluster is deployed.

    ### Option B - Use an existing ingress controller

    Use these steps only if there is existing ingress controller on the cluster which already has a DNS name.  This will NOT expose the Jenkins service with a public IP since the ingress controller should contain the public IP address and name used to access Jenkins.

    To accomplish this:

    - Change line 48 `ServiceType` to `ClusterIP`.
    - Uncomment and change line 53 `HostName` to match the name of the DNS name associated with the existing ingress controller service.
    - Uncomment line 131 and replace the `nginx` value with the required annotation for the existing ingress controller if using something other than nginx. i.e. `traefik`

2. Deploy Jenkins on top of your K8s cluster

    Specify the modified values.yaml file after `-f` in the below command from the previous step OR just use the default from this repo if skipping the above step.

    `helm install --name k8sjenkins -f https://raw.githubusercontent.com/dtzar/blog/master/Jenkins-CI-Pipeline-K8s/code/values.yaml stable/jenkins --version 0.16.6`

    This configuration will create a new service of type Loadbalancer which will expose Jenkins directly with a public IP address.

    > Note: It may take a few minutes to complete the deployment since the Jenkins container needs to wait for a PVC to be created and install the Jenkins plugins.

3. Login to the cluster from the output of the helm chart deployment.

    ```shell
    printf $(kubectl get secret --namespace default k8sjenkins -o jsonpath="{.data.jenkins-admin-password}" | base64 --decode);echo
    export SERVICE_IP=$(kubectl get svc --namespace default k8sjenkins-jenkins --template "{{ range (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}")
    echo http://$SERVICE_IP:8080/login
    ```

    Now visit the URL above and login to Jenkins.  
    The username from the template is `jenkinsadmin`.

## Configure Jenkins to utilize your Jenkinsfile pipeline from a GitHub repo

## Execute the pipeline

TO DO - complete the other two sections...